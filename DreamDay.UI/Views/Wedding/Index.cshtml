@{
    ViewData["Title"] = "Create New Wedding";
}

@if (User.IsInRole("User"))
{

    <div class="container-fluid py-4">
        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-9">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">Plan Your Wedding</h3>
                        <div class="progress" style="width: 300px; height: 20px;">
                            <div class="progress-bar" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">Step 1 of 4</div>
                        </div>
                    </div>

                    <!-- Wedding Creation Wizard -->
                    <div class="card-body">
                        <form id="weddingForm" method="post" enctype="multipart/form-data">
                            <!-- Step 1: Basic Information -->
                            <div class="wizard-step" id="step1">
                                <h5 class="text-primary border-bottom pb-2 mb-4">Wedding Details</h5>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="weddingName" class="form-label">Wedding Name/Couple's Name*</label>
                                        <input type="text" class="form-control" id="weddingName" name="weddingName" required placeholder="e.g. Sarah & John's Wedding">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="weddingDate" class="form-label">Wedding Date*</label>
                                        <input type="date" class="form-control" id="weddingDate" name="weddingDate" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="weddingLocation" class="form-label">Location/Venue*</label>
                                        <input type="text" class="form-control" id="weddingLocation" name="weddingLocation" required placeholder="Enter venue name or address">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="weddingTheme" class="form-label">Wedding Theme</label>
                                        <input type="text" class="form-control" id="weddingTheme" name="weddingTheme" placeholder="e.g. Beach, Vintage, Modern">
                                    </div>
                                    <div class="col-12">
                                        <label for="weddingDescription" class="form-label">Description</label>
                                        <textarea class="form-control" id="weddingDescription" name="weddingDescription" rows="3" placeholder="Tell us about your wedding vision"></textarea>
                                    </div>
                                    <div class="col-12">
                                        <label for="coverImage" class="form-label">Cover Image</label>
                                        <input type="file" class="form-control" id="coverImage" name="coverImage" accept="image/*">
                                    </div>
                                </div>
                            </div>

                            <!-- Step 2: Guest Management -->
                            <div class="wizard-step d-none" id="step2">
                                <h5 class="text-primary border-bottom pb-2 mb-4">Guest Management</h5>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="estimatedGuests" class="form-label">Estimated Number of Guests*</label>
                                        <input type="number" class="form-control" id="estimatedGuests" name="estimatedGuests" required min="1" value="100">
                                        <small class="text-muted">This will help calculate approximate costs</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="guestList" class="form-label">Upload Guest List (CSV)</label>
                                        <input type="file" class="form-control" id="guestList" name="guestList" accept=".csv">
                                        <small class="text-muted">Format: Name,Email,Phone,RSVP Status</small>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="enableRSVP" name="enableRSVP">
                                            <label class="form-check-label" for="enableRSVP">
                                                Enable Online RSVP System
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-12 mt-3">
                                        <h6>Guest Categories</h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm" id="guestCategories">
                                                <thead>
                                                    <tr>
                                                        <th>Category</th>
                                                        <th>Count</th>
                                                        <th>Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td><input type="text" class="form-control form-control-sm" name="guestCategories[0].name" placeholder="e.g. Family"></td>
                                                        <td><input type="number" class="form-control form-control-sm" name="guestCategories[0].count" min="0"></td>
                                                        <td><button type="button" class="btn btn-sm btn-outline-danger remove-category"><i class="bi bi-trash"></i></button></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                            <button type="button" class="btn btn-sm btn-outline-primary" id="addCategory">Add Category</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 3: Budget Planning -->
                            <div class="wizard-step d-none" id="step3">
                                <h5 class="text-primary border-bottom pb-2 mb-4">Budget Planning</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card mb-4">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0">Budget Summary</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label for="totalBudget" class="form-label">Total Budget ($)*</label>
                                                    <input type="number" class="form-control" id="totalBudget" name="totalBudget" required min="1000" step="100" value="10000">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="budgetPerGuest" class="form-label">Estimated Cost Per Guest</label>
                                                    <input type="number" class="form-control" id="budgetPerGuest" name="budgetPerGuest" readonly>
                                                    <small class="text-muted">Calculated based on total budget and guest count</small>
                                                </div>
                                                <div class="alert alert-info">
                                                    <i class="bi bi-info-circle"></i> Based on <span id="guestCountDisplay">100</span> guests, your estimated per guest cost is $<span id="perGuestCost">100</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0">Budget Allocation</h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="budgetAllocationChart" style="height: 200px;"></div>
                                                <div class="mt-3">
                                                    <label class="form-label">Budget Breakdown</label>
                                                    <div class="table-responsive">
                                                        <table class="table table-sm">
                                                            <thead>
                                                                <tr>
                                                                    <th>Category</th>
                                                                    <th>Percentage</th>
                                                                    <th>Amount</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr>
                                                                    <td>Venue</td>
                                                                    <td><input type="number" class="form-control form-control-sm" name="venuePercent" value="40" min="0" max="100">%</td>
                                                                    <td>$<span class="venueAmount">4000</span></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>Catering</td>
                                                                    <td><input type="number" class="form-control form-control-sm" name="cateringPercent" value="30" min="0" max="100">%</td>
                                                                    <td>$<span class="cateringAmount">3000</span></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>Photography</td>
                                                                    <td><input type="number" class="form-control form-control-sm" name="photographyPercent" value="10" min="0" max="100">%</td>
                                                                    <td>$<span class="photographyAmount">1000</span></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>Entertainment</td>
                                                                    <td><input type="number" class="form-control form-control-sm" name="entertainmentPercent" value="8" min="0" max="100">%</td>
                                                                    <td>$<span class="entertainmentAmount">800</span></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>Other</td>
                                                                    <td><input type="number" class="form-control form-control-sm" name="otherPercent" value="12" min="0" max="100">%</td>
                                                                    <td>$<span class="otherAmount">1200</span></td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 4: Vendor & Services -->
                            <div class="wizard-step d-none" id="step4">
                                <h5 class="text-primary border-bottom pb-2 mb-4">Vendors & Services</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card mb-4">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0">Required Services</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label">Select Needed Services</label>
                                                    <div class="list-group">
                                                        <div class="list-group-item">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="photographer" name="services" value="Photographer">
                                                                <label class="form-check-label" for="photographer">Photographer</label>
                                                            </div>
                                                        </div>
                                                        <div class="list-group-item">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="catering" name="services" value="Catering">
                                                                <label class="form-check-label" for="catering">Catering</label>
                                                            </div>
                                                        </div>
                                                        <div class="list-group-item">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="florist" name="services" value="Florist">
                                                                <label class="form-check-label" for="florist">Florist</label>
                                                            </div>
                                                        </div>
                                                        <div class="list-group-item">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="music" name="services" value="Music">
                                                                <label class="form-check-label" for="music">Music/DJ</label>
                                                            </div>
                                                        </div>
                                                        <div class="list-group-item">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="planner" name="services" value="Planner">
                                                                <label class="form-check-label" for="planner">Wedding Planner</label>
                                                            </div>
                                                        </div>
                                                        <div class="list-group-item">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="decor" name="services" value="Decor">
                                                                <label class="form-check-label" for="decor">Decorations</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                                <h6 class="mb-0">Vendor Requests</h6>
                                                <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#vendorSearchModal">
                                                    <i class="bi bi-search"></i> Find Vendors
                                                </button>
                                            </div>
                                            <div class="card-body">
                                                <div id="selectedVendors">
                                                    <p class="text-muted">No vendors selected yet. Click "Find Vendors" to search and add vendors to your wedding.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 5: Agenda & Timeline -->
                            <div class="wizard-step d-none" id="step5">
                                <h5 class="text-primary border-bottom pb-2 mb-4">Wedding Agenda</h5>
                                <div class="row">
                                    <div class="col-12">
                                        <div class="card mb-4">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0">Event Timeline</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table" id="agendaTable">
                                                        <thead>
                                                            <tr>
                                                                <th>Time</th>
                                                                <th>Event</th>
                                                                <th>Location</th>
                                                                <th>Responsible</th>
                                                                <th>Notes</th>
                                                                <th>Action</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td><input type="time" class="form-control form-control-sm" name="agenda[0].time"></td>
                                                                <td><input type="text" class="form-control form-control-sm" name="agenda[0].event" placeholder="e.g. Ceremony"></td>
                                                                <td><input type="text" class="form-control form-control-sm" name="agenda[0].location"></td>
                                                                <td><input type="text" class="form-control form-control-sm" name="agenda[0].responsible"></td>
                                                                <td><input type="text" class="form-control form-control-sm" name="agenda[0].notes"></td>
                                                                <td><button type="button" class="btn btn-sm btn-outline-danger remove-agenda"><i class="bi bi-trash"></i></button></td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                    <button type="button" class="btn btn-sm btn-outline-primary" id="addAgendaItem">Add Event</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Navigation Buttons -->
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary" id="prevBtn" disabled>
                                    <i class="bi bi-arrow-left"></i> Previous
                                </button>
                                <button type="button" class="btn btn-primary px-4" id="nextBtn">
                                    Next <i class="bi bi-arrow-right"></i>
                                </button>
                                <button type="submit" class="btn btn-success px-4 d-none" id="submitBtn">
                                    <i class="bi bi-save"></i> Create Wedding Plan
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-3">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">Wedding Summary</h6>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <img src="https://via.placeholder.com/300x150?text=Wedding+Cover" alt="Cover Image" class="img-fluid rounded mb-2" id="coverPreview">
                        </div>
                        <h5 id="weddingNamePreview">Wedding Name</h5>
                        <p class="text-muted" id="weddingDatePreview">Date not set</p>
                        <p class="text-muted" id="weddingLocationPreview">Location not set</p>

                        <hr>

                        <div class="mb-3">
                            <h6>Guest Count</h6>
                            <p class="mb-1" id="guestCountPreview">0 guests</p>
                            <div class="progress" style="height: 5px;">
                                <div class="progress-bar bg-primary" role="progressbar" style="width: 0%;"></div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <h6>Budget</h6>
                            <p class="mb-1" id="budgetPreview">$0</p>
                            <small class="text-muted" id="perGuestPreview">$0 per guest</small>
                        </div>

                        <div class="mb-3">
                            <h6>Vendors</h6>
                            <ul class="list-unstyled" id="vendorsPreview">
                                <li>No vendors selected</li>
                            </ul>
                        </div>

                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Complete all steps to finalize your wedding plan.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vendor Search Modal -->
    <div class="modal fade" id="vendorSearchModal" tabindex="-1" aria-labelledby="vendorSearchModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="vendorSearchModalLabel">Find Vendors</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Search vendors..." id="vendorSearchInput">
                            <button class="btn btn-outline-secondary" type="button" id="vendorSearchBtn">Search</button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Filter by Category</label>
                        <select class="form-select" id="vendorCategoryFilter">
                            <option value="">All Categories</option>
                            <option>Photography</option>
                            <option>Catering</option>
                            <option>Florist</option>
                            <option>Music</option>
                            <option>Planning</option>
                            <option>Venue</option>
                        </select>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover" id="vendorResultsTable">
                            <thead>
                                <tr>
                                    <th>Vendor</th>
                                    <th>Category</th>
                                    <th>Rating</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Sample vendor data - in real app this would come from API -->
                                <tr>
                                    <td>Elegant Photography</td>
                                    <td>Photography</td>
                                    <td>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-half text-warning"></i>
                                        <span class="ms-1">4.5</span>
                                    </td>
                                    <td><button class="btn btn-sm btn-outline-primary select-vendor">Select</button></td>
                                </tr>
                                <tr>
                                    <td>Gourmet Catering Co.</td>
                                    <td>Catering</td>
                                    <td>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <span class="ms-1">5.0</span>
                                    </td>
                                    <td><button class="btn btn-sm btn-outline-primary select-vendor">Select</button></td>
                                </tr>
                                <tr>
                                    <td>Blooms & Petals</td>
                                    <td>Florist</td>
                                    <td>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star text-warning"></i>
                                        <span class="ms-1">4.0</span>
                                    </td>
                                    <td><button class="btn btn-sm btn-outline-primary select-vendor">Select</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>


}
else
{
    <div class="alert alert-danger mt-5" role="alert">
        <h4 class="alert-heading"><i class="bi bi-shield-lock me-2"></i>Access Denied</h4>
        <p>You don't have permission to access this page. Only Users can Create Wedding</p>
        <hr>
        <p class="mb-0">If you believe this is an error, please contact your system administrator.</p>
    </div>

}


@section Scripts {
    <script>
        $(document).ready(function() {
            // Wizard navigation
            let currentStep = 1;
            const totalSteps = 5;

            // Update progress bar
            function updateProgress() {
                const percent = (currentStep / totalSteps) * 100;
                $('.progress-bar').css('width', percent + '%').text('Step ' + currentStep + ' of ' + totalSteps);

                // Update button states
                $('#prevBtn').prop('disabled', currentStep === 1);
                $('#nextBtn').toggle(currentStep < totalSteps);
                $('#submitBtn').toggle(currentStep === totalSteps);
            }

            // Next button click
            $('#nextBtn').click(function() {
                if (validateStep(currentStep)) {
                    $('.wizard-step').addClass('d-none');
                    currentStep++;
                    $('#step' + currentStep).removeClass('d-none');
                    updateProgress();
                }
            });

            // Previous button click
            $('#prevBtn').click(function() {
                $('.wizard-step').addClass('d-none');
                currentStep--;
                $('#step' + currentStep).removeClass('d-none');
                updateProgress();
            });

            // Validate current step
            function validateStep(step) {
                let isValid = true;

                if (step === 1) {
                    if ($('#weddingName').val() === '') {
                        alert('Please enter a wedding name');
                        isValid = false;
                    }
                    if ($('#weddingDate').val() === '') {
                        alert('Please select a wedding date');
                        isValid = false;
                    }
                    if ($('#weddingLocation').val() === '') {
                        alert('Please enter a wedding location');
                        isValid = false;
                    }
                } else if (step === 2) {
                    if ($('#estimatedGuests').val() === '' || parseInt($('#estimatedGuests').val()) <= 0) {
                        alert('Please enter a valid guest count');
                        isValid = false;
                    }
                } else if (step === 3) {
                    if ($('#totalBudget').val() === '' || parseInt($('#totalBudget').val()) <= 0) {
                        alert('Please enter a valid budget amount');
                        isValid = false;
                    }
                }

                if (isValid) {
                    updateSummaryPreview();
                }

                return isValid;
            }

            // Update summary preview
            function updateSummaryPreview() {
                // Basic info
                $('#weddingNamePreview').text($('#weddingName').val() || 'Wedding Name');
                $('#weddingDatePreview').text($('#weddingDate').val() ? new Date($('#weddingDate').val()).toLocaleDateString() : 'Date not set');
                $('#weddingLocationPreview').text($('#weddingLocation').val() || 'Location not set');

                // Guest count
                const guestCount = parseInt($('#estimatedGuests').val()) || 0;
                $('#guestCountPreview').text(guestCount + ' guest' + (guestCount !== 1 ? 's' : ''));
                $('.progress-bar', '#guestCountPreview').parent().css('width', Math.min(guestCount / 200 * 100, 100) + '%');

                // Budget
                const totalBudget = parseInt($('#totalBudget').val()) || 0;
                $('#budgetPreview').text('$' + totalBudget.toLocaleString());
                const perGuest = guestCount > 0 ? Math.round(totalBudget / guestCount) : 0;
                $('#perGuestPreview').text('$' + perGuest + ' per guest');
                $('#budgetPerGuest').val(perGuest);

                // Cover image preview
                if ($('#coverImage')[0].files && $('#coverImage')[0].files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        $('#coverPreview').attr('src', e.target.result);
                    };
                    reader.readAsDataURL($('#coverImage')[0].files[0]);
                }
            }

            // Budget calculation
            function calculateBudget() {
                const totalBudget = parseInt($('#totalBudget').val()) || 0;
                const guestCount = parseInt($('#estimatedGuests').val()) || 0;

                $('input[name$="Percent"]').each(function() {
                    const percent = parseInt($(this).val()) || 0;
                    const amount = Math.round(totalBudget * percent / 100);
                    const className = $(this).attr('name').replace('Percent', 'Amount');
                    $('.' + className).text(amount);
                });

                if (guestCount > 0) {
                    $('#budgetPerGuest').val(Math.round(totalBudget / guestCount));
                }
            }

            // Event listeners
            $('#estimatedGuests, #totalBudget').on('input', function() {
                calculateBudget();
                updateSummaryPreview();
            });

            $('input[name$="Percent"]').on('input', function() {
                calculateBudget();
            });

            $('#coverImage').change(function() {
                updateSummaryPreview();
            });

            // Add guest category
            let categoryCount = 1;
            $('#addCategory').click(function() {
                const newRow = `
                    <tr>
                        <td><input type="text" class="form-control form-control-sm" name="guestCategories[${categoryCount}].name"></td>
                        <td><input type="number" class="form-control form-control-sm" name="guestCategories[${categoryCount}].count" min="0"></td>
                        <td><button type="button" class="btn btn-sm btn-outline-danger remove-category"><i class="bi bi-trash"></i></button></td>
                    </tr>
                `;
                $('#guestCategories tbody').append(newRow);
                categoryCount++;
            });

            // Remove guest category
            $(document).on('click', '.remove-category', function() {
                $(this).closest('tr').remove();
            });

            // Add agenda item
            let agendaCount = 1;
            $('#addAgendaItem').click(function() {
                const newRow = `
                    <tr>
                        <td><input type="time" class="form-control form-control-sm" name="agenda[${agendaCount}].time"></td>
                        <td><input type="text" class="form-control form-control-sm" name="agenda[${agendaCount}].event" placeholder="e.g. Ceremony"></td>
                        <td><input type="text" class="form-control form-control-sm" name="agenda[${agendaCount}].location"></td>
                        <td><input type="text" class="form-control form-control-sm" name="agenda[${agendaCount}].responsible"></td>
                        <td><input type="text" class="form-control form-control-sm" name="agenda[${agendaCount}].notes"></td>
                        <td><button type="button" class="btn btn-sm btn-outline-danger remove-agenda"><i class="bi bi-trash"></i></button></td>
                    </tr>
                `;
                $('#agendaTable tbody').append(newRow);
                agendaCount++;
            });

            // Remove agenda item
            $(document).on('click', '.remove-agenda', function() {
                $(this).closest('tr').remove();
            });

            // Vendor selection
            $(document).on('click', '.select-vendor', function() {
                const vendorRow = $(this).closest('tr');
                const vendorName = vendorRow.find('td:eq(0)').text();
                const vendorCategory = vendorRow.find('td:eq(1)').text();

                if ($('#vendorsPreview li:contains("' + vendorName + '")').length === 0) {
                    $('#vendorsPreview').append('<li>' + vendorName + ' <small class="text-muted">(' + vendorCategory + ')</small></li>');

                    $('#selectedVendors').append(`
                        <div class="card mb-2">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">${vendorName}</h6>
                                        <small class="text-muted">${vendorCategory}</small>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-vendor">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `);

                    // Show success message if it was the first vendor
                    if ($('#selectedVendors .card').length === 1) {
                        $('#selectedVendors p.text-muted').hide();
                    }
                }

                $('#vendorSearchModal').modal('hide');
            });

            // Remove vendor
            $(document).on('click', '.remove-vendor', function() {
                const vendorCard = $(this).closest('.card');
                const vendorName = vendorCard.find('h6').text();

                vendorCard.remove();
                $('#vendorsPreview li:contains("' + vendorName + '")').remove();

                // Show placeholder if no vendors left
                if ($('#selectedVendors .card').length === 0) {
                    $('#selectedVendors p.text-muted').show();
                }
            });

            // Initialize
            updateProgress();
            calculateBudget();
            updateSummaryPreview();
        });
    </script>
}